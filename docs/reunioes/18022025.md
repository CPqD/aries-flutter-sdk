# 18/02 - ğŸ“œ Processo de ComunicaÃ§Ã£o com DIDComm

## ğŸ“Œ Ãndice
1. [ConexÃ£o entre Agentes](#conexÃ£o-entre-agentes)
2. [EmissÃ£o de Credencial](#emissÃ£o-de-credencial)
3. [Prova de Credencial](#prova-de-credencial)
4. [TranscriÃ§Ãµes de ReuniÃµes](#ğŸ“‚-transcriÃ§Ãµes-de-reuniÃµes)

## ğŸ”— ConexÃ£o entre Agentes

### ğŸ‘¥ Agentes Envolvidos:
- **Alice**
- **Bob**

### ğŸ”„ Processo de ConexÃ£o:
1. **Alice envia um convite de conexÃ£o** contendo um DID associado a ela:
   - O agente de Alice cria um DID.
   - O DID contÃ©m um par de chaves que serÃ¡ usado para encriptaÃ§Ã£o.
   - O DID Ã© armazenado na wallet, contendo a chave privada.
   - A chave pÃºblica Ã© enviada no convite (`recipient_key`) para o destinatÃ¡rio.

2. **Bob recebe o convite e cria um DID prÃ³prio**, adicionando sua chave pÃºblica e respondendo com a aceitaÃ§Ã£o da conexÃ£o.
3. **ApÃ³s a troca de mensagens**, ambos conhecem as chaves pÃºblicas um do outro.
4. **ACA-Py e Credo (por padrÃ£o) enviam uma mensagem de conexÃ£o OK**.
5. **Com a conexÃ£o estabelecida**, todas as mensagens futuras serÃ£o encriptadas.
6. **Os agentes utilizam os DIDs para comunicaÃ§Ã£o segura**.
   - Como ambos possuem as chaves pÃºblicas, podem encriptar e decriptar mensagens.
   - Isso marca o inÃ­cio da **DIDComm**.

### ğŸ“¡ Protocolo DIDComm
- ApÃ³s a conexÃ£o, os agentes podem trocar mensagens.
- Se ambos os agentes possuem **IP fixo**, podem usar **Basic Message**:
  - Alice pega seu DID, encripta a mensagem e a envia via DIDComm para Bob.
  - Bob recebe a mensagem encriptada, decripta com seu DID e visualiza o conteÃºdo.
- A comunicaÃ§Ã£o pode ser feita via **HTTP** ou **WebSocket**.

### ğŸ·ï¸ MediaÃ§Ã£o
- **ImplementaÃ§Ã£o do processo de mediaÃ§Ã£o**:
  - O Credo TS possui suporte, mas o Flutter nÃ£o.
- **CenÃ¡rio com IP fixo e variÃ¡vel**:
  - Enviar mensagem do Flutter para o emissor funciona pois o emissor tem IP fixo.
  - O retorno do emissor para o Flutter falha pois o Flutter nÃ£o tem IP fixo.
  - SoluÃ§Ã£o: **Uso de mediador**, que retransmite mensagens para o Flutter.

## ğŸŸï¸ EmissÃ£o de Credencial

### ğŸ¢ Agentes Envolvidos:
- **Portador** (Dart)
- **Emissor** (ACA-Py)

### ğŸ” Processo de EmissÃ£o:
1. O emissor deseja oferecer uma credencial e envia uma mensagem para o portador.
2. Se o portador (GovBR/Dart) nÃ£o estiver aberto, o WebSocket nÃ£o estarÃ¡ ativo.
3. O mediador gerencia a comunicaÃ§Ã£o:
   - Se o WebSocket estiver aberto, envia a mensagem diretamente.
   - Caso contrÃ¡rio, coloca na fila e envia quando o WebSocket abrir.
4. O Dart se conecta ao mediador (ACA-Py).
5. O mediador mantÃ©m uma lista de conexÃµes entre emissor e portador.
6. No envio da oferta:
   - O emissor pega o **CredDef** da carteira e insere os dados (ex: nome, e-mail).
   - A oferta Ã© encriptada com a chave privada da **CredDef** (armazenada na carteira Askar do ACA-Py).
   - A oferta Ã© enviada ao holder.
7. O holder decripta a mensagem e valida a oferta:
   - Verifica os dados na blockchain (Besu) e recupera o **CredDef** e o **Schema**.
   - O AnonCreds valida a estrutura da credencial.
   - Se a credencial for aceita, o holder envia um request para o emissor.
8. O emissor recebe a requisiÃ§Ã£o, decripta e emite a credencial assinada.
9. O holder verifica a assinatura na blockchain e armazena na **Askar**.
10. O holder envia um **ACK** confirmando o recebimento da credencial.

<img src="../images/emissao_de_credencial.png" alt="EmissÃ£o de Credencial" width="600">

### âš ï¸ Tratamento de Erros
- Se houver erro nos dados, o **issuer** envia um `problem-report`.
- O `problem-report` tambÃ©m Ã© encriptado via **DIDComm**.
- Toda a comunicaÃ§Ã£o entre **portador e emissor** Ã© segura e encriptada.

## ğŸ“œ Prova de Credencial

### ğŸ“– Processo:
1. O **Prover** jÃ¡ possui uma credencial e deseja provar sua autenticidade ao **Verificador**.
2. A conexÃ£o entre os agentes jÃ¡ deve estar estabelecida.
3. O Verificador solicita uma **prova de credencial** especÃ­fica (ex: nome, e-mail).
4. O Prover recebe a solicitaÃ§Ã£o e decripta a mensagem:
   - Valida os dados na blockchain.
   - Verifica na carteira Askar se possui a credencial.
   - Decide se deseja revelar os dados.
5. Se aceitar:
   - Envia um `send_presentation`, contendo a CredDef.
   - Consulta a blockchain para verificar o status da credencial (se Ã© revogÃ¡vel, consulta o registro de revogaÃ§Ã£o).
   - Encapsula tudo e envia ao Verificador.
6. O Verificador recebe a apresentaÃ§Ã£o e faz validaÃ§Ãµes:
   - Confirma na blockchain o schema e a revogaÃ§Ã£o.
   - Se tudo estiver correto, envia um **ACK-Presentation** confirmando a validaÃ§Ã£o.

<img src="../images/prova_de_credencial.png" alt="Prova de Credencial" width="600">

### âŒ Caso de RejeiÃ§Ã£o
- Se o Prover nÃ£o deseja compartilhar a credencial:
  - No app Dart, o usuÃ¡rio pode recusar.
  - O Prover envia um `problem-report` ao Verificador, encerrando o processo.

